<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="icon" type="image/svg+xml" href="img/logo.svg"/>
        <link rel="stylesheet" href="css/style.css" />
    </head>
<body>
    <script src="js/elm.js"></script>
    <script>
        var app = Elm.Main.init({
            flags: {
                width: window.innerWidth,
                height: window.innerHeight
            }
        });
        /* Add commands / subscriptions onto the app below */
        app.ports.evaluateString.subscribe(function (val) { app.ports.evaluateResult.send({"id": val["id"], "value": eval(val["str"])}); });
        window.document.addEventListener("keydown", function(e) {
            // Only send Undo, Redo and Escape
            if ((e.ctrlKey || e.metaKey) && e.key == "z" || e.key == "Escape" || e.key == " ") {
                app.ports.onKeyDown.send({"ctrl": e.ctrlKey || e.metaKey, "shift": e.shiftKey, "key": e.key});
                e.preventDefault(); // Block browser's default undo/redo
            }
        });
        app.ports.focusOutCmd.subscribe(function (val) {
            let id = val["id"];
            let cancelFunc;
            let target = document.getElementById(id);
            let onFocusOut = function (e) {
                if (!target.contains(event.relatedTarget)) {
                    app.ports.focusOutSub.send({"id": id});
                    cancelFunc();
                }
            };
            cancelFunc = function() {target.removeEventListener("focusout", onFocusOut);};
            target.addEventListener("focusout", onFocusOut);
        });
        app.ports.svgMouseBegin.subscribe(function (val) {
            let id = val["id"];
            let convertPoint = function(x, y) { return {"x": x, "y": y}; };
            if (val["svg"]) {
                let target = document.getElementById(id).getElementsByClassName("bricks");
                if (target.length != 1) target = document.getElementById(id).getElementsByTagName("svg")
                if (target.length < 1) return;
                let svgTarget = target[0];
                convertPoint = function(x, y) {
                    // https://stackoverflow.com/a/20958980
                    let p = svgTarget.createSVGPoint();
                    p.x = x;
                    p.y = y;
                    return p.matrixTransform(svgTarget.getScreenCTM().inverse());
                }
            }
            let target = document.getElementById("draggableListener");  // This is our global drag event listener
            let start = Date.now();
            let startP = convertPoint(val["x"], val["y"]);
            var cancelFunc;
            let onMove = function() {
                return function(e) {
                    let p = convertPoint(e.clientX, e.clientY);
                    app.ports.svgMouseEvent.send({"event": 1, "id": id, "x": p.x, "y": p.y, "time": Date.now() - start});
                }
            }();
            let onFinish = function() {
                return function(e) {
                    let p = convertPoint(e.clientX, e.clientY);
                    app.ports.svgMouseEvent.send({"event": 2, "id": id, "x": p.x, "y": p.y, "time": Date.now() - start});
                    cancelFunc();
                }
            }();
            cancelFunc = function() {
                target.removeEventListener("pointermove", onMove);
                target.removeEventListener("pointerup", onFinish);
                target.removeEventListener("pointercancel", onFinish);
                target.releasePointerCapture(val["pointerID"]);
            }
            target.addEventListener("pointermove", onMove);
            target.addEventListener("pointerup", onFinish);
            target.addEventListener("pointercancel", onFinish);
            target.setPointerCapture(val["pointerID"]);
            // Send the start version
            app.ports.svgMouseEvent.send({"event": 0, "id": id, "x": startP.x, "y": startP.y, "time": 0});
        });
    </script>
</body>
</html>