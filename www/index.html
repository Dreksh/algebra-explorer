<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="css/style.css" />
    </head>
<body>
    <script src="js/elm.js"></script>
    <script>
        var app = Elm.Main.init({
            flags: {
                width: window.innerWidth,
                height: window.innerHeight
            }
        });
        /* Add commands / subscriptions onto the app below */
        app.ports.evaluateString.subscribe(function (val) { app.ports.evaluateResult.send({"id": val["id"], "value": eval(val["str"])}); });
        app.ports.capture.subscribe(function (val) {
            if (val["set"]) document.getElementById(val["eId"]).setPointerCapture(val["pId"]);
            else document.getElementById(val["eId"]).releasePointerCapture(val["pId"]);
        });
        window.document.addEventListener("keydown", function(e) {
            // Only send Undo, Redo and Escape
            if ((e.ctrlKey || e.metaKey) && e.key == "z" || e.key == "Escape") {
                app.ports.onKeyDown.send({"ctrl": e.ctrlKey || e.metaKey, "shift": e.shiftKey, "key": e.key});
                e.preventDefault(); // Block browser's default undo/redo
            }
        });
        app.ports.svgMouseBegin.subscribe(function (val) {
            let target = document.getElementById("Equation-"+val["id"]).getElementsByClassName("bricks");
            if (target.length != 1) return;
            let svgTarget = target[0];
            let convertPoint = function(e) {
                // https://stackoverflow.com/a/20958980
                let p = svgTarget.createSVGPoint();
                p.x = e.clientX;
                p.y = e.clientY;
                return p.matrixTransform(svgTarget.getScreenCTM().inverse());
            }
            var cancelFunc;
            let onMove = function(id) {
                return function(e) {
                    let p = convertPoint(e);
                    app.ports.svgMouseEvent.send({"final": false, "id": id, "x": p.x, "y": p.y, "time": 0});
                }
            }(val["id"]);
            let onFinish = function(start, id) {
                return function(e) {
                    let p = convertPoint(e);
                    app.ports.svgMouseEvent.send({"final": true, "id": id, "x": p.x, "y": p.y, "time": Date.now() - start});
                    cancelFunc();
                }
            }(Date.now(), val["id"]);
            let onLeave = function(start, id) {
                return function(e) {
                    cancelFunc();
                }
            }(Date.now(), val["id"]);
            cancelFunc = function() {
                svgTarget.removeEventListener("mousemove", onMove);
                svgTarget.removeEventListener("mouseup", onFinish);
            }
            svgTarget.addEventListener("mousemove", onMove);
            svgTarget.addEventListener("mouseup", onFinish);
            svgTarget.addEventListener("mouseleave", onLeave);
        });
    </script>
</body>
</html>