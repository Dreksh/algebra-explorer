<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="css/style.css" />
    </head>
<body>
    <script src="js/elm.js"></script>
    <script>
        var app = Elm.Main.init({
            flags: {
                width: window.innerWidth,
                height: window.innerHeight
            }
        });
        /* Add commands / subscriptions onto the app below */
        app.ports.evaluateString.subscribe(function (val) { app.ports.evaluateResult.send({"id": val["id"], "value": eval(val["str"])}); });
        app.ports.capture.subscribe(function (val) {
            if (val["set"]) document.getElementById(val["eId"]).setPointerCapture(val["pId"]);
            else document.getElementById(val["eId"]).releasePointerCapture(val["pId"]);
        });
        window.document.addEventListener("keydown", function(e) {
            // Only send Undo, Redo and Escape
            if ((e.ctrlKey || e.metaKey) && e.key == "z" || e.key == "Escape") {
                app.ports.onKeyDown.send({"ctrl": e.ctrlKey || e.metaKey, "shift": e.shiftKey, "key": e.key});
                e.preventDefault(); // Block browser's default undo/redo
            }
        });
        app.ports.svgMouseBegin.subscribe(function (val) {
            let id = val["id"];
            let target = document.getElementById(id).getElementsByClassName("bricks");
            if (target.length != 1) target = document.getElementById(id).getElementsByTagName("svg")
            if (target.length < 1) return;
            let start = Date.now();
            let svgTarget = target[0];
            let convertPoint = function(x, y) {
                // https://stackoverflow.com/a/20958980
                let p = svgTarget.createSVGPoint();
                p.x = x;
                p.y = y;
                return p.matrixTransform(svgTarget.getScreenCTM().inverse());
            }
            let startP = convertPoint(val["x"], val["y"]);
            var cancelFunc;
            let onMove = function() {
                return function(e) {
                    let p = convertPoint(e.clientX, e.clientY);
                    app.ports.svgMouseEvent.send({"event": 1, "id": id, "x": p.x, "y": p.y, "time": Date.now() - start});
                }
            }();
            let onFinish = function() {
                return function(e) {
                    let p = convertPoint(e.clientX, e.clientY);
                    app.ports.svgMouseEvent.send({"event": 2, "id": id, "x": p.x, "y": p.y, "time": Date.now() - start});
                    cancelFunc();
                }
            }();
            cancelFunc = function() {
                svgTarget.removeEventListener("pointermove", onMove);
                svgTarget.removeEventListener("pointerup", onFinish);
                svgTarget.removeEventListener("pointercancel", onFinish);
                svgTarget.releasePointerCapture(val["pointerID"]);
            }
            svgTarget.addEventListener("pointermove", onMove);
            svgTarget.addEventListener("pointerup", onFinish);
            svgTarget.addEventListener("pointercancel", onFinish);
            svgTarget.setPointerCapture(val["pointerID"]);
            // TODO: start timer for activating hold semantic
            // Send the start version
            app.ports.svgMouseEvent.send({"event": 0, "id": id, "x": startP.x, "y": startP.y, "time": 0});
        });
    </script>
</body>
</html>